frameworkVersion: '3'

useDotenv: true

service: infra-sight

plugins:
  - serverless-esbuild
  - serverless-offline

custom:
  esbuild:
    target: node18
    sourcemap: true
    exclude:
      - '@aws-sdk/client-s3'

  name: ${self:service}-${opt:stage, self:provider.stage}
  domain: ${self:custom.stage.${opt:stage, self:provider.stage}.domain}
  bucket: !Ref Bucket
  url: https://${self:custom.domain}/
  stage:
    production:
      domain: ${env:DOMAIN_NAME_PRODUCTION, 'infra-sight.api.aidan.pro'}
    staging:
      domain: ${env:DOMAIN_NAME_STAGING, 'infra-sight.api.staging.aidan.pro'}
    development:
      domain: ${env:DOMAIN_NAME_DEVELOPMENT, 'infra-sight.api.development.aidan.pro'}
    test:
      domain: ${env:DOMAIN_NAME_TEST, 'localhost:3000'}

provider:
  name: aws
  runtime: nodejs18.x
  tracing:
    lambda: true
  stage: development
  region: us-east-1
  stackName: ${self:custom.name}
  apiName: ${self:custom.name}
  timeout: 28
  environment:
    NODE_OPTIONS: --enable-source-maps
    DD_API_KEY: ${env:DD_API_KEY, null}
    DD_OTLP_CONFIG_RECEIVER_PROTOCOLS_HTTP_ENDPOINT: localhost:4318
    AWS_BUCKET: ${env:AWS_BUCKET, self:custom.bucket}
    INFRA_SIGHT_API_URL: ${env:INFRA_SIGHT_API_URL, self:custom.url}
    S3_CONFIG: ${env:S3_CONFIG, null}
    SERVERLESS_STAGE: ${opt:stage, self:provider.stage}
  layers:
    - arn:aws:lambda:${aws:region}:464622532012:layer:Datadog-Extension-ARM:44
  architecture: arm64
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:ListBucket
          Resource:
            - !GetAtt
              - Bucket
              - Arn
            - !Join
              - /
              - - !GetAtt
                  - Bucket
                  - Arn
                - v2
                - cdn
                - '*'
        - Effect: Allow
          Action:
            - s3:PutObject
          Resource:
            - !Join
              - /
              - - !GetAtt
                  - Bucket
                  - Arn
                - v2
                - cdn
                - '*'
  httpApi:
    name: ${self:custom.name}

package:
  individually: true

functions:
  SearchOverwatchAccounts:
    handler: src/functions/search-overwatch-accounts.searchOverwatchAccounts
    events:
      - httpApi:
          method: GET
          path: /v2/api/overwatch/accounts/{username}/search

  GetOverwatchAccount:
    handler: src/functions/get-overwatch-account.getOverwatchAccount
    events:
      - httpApi:
          method: GET
          path: /v2/api/overwatch/accounts/{username}/latest

  GetOverwatchHeroes:
    handler: src/functions/get-overwatch-heroes.getOverwatchHeroes
    events:
      - httpApi:
          method: GET
          path: /v2/api/overwatch/heroes/latest

  GetOverwatchPlayerIcons:
    handler: src/functions/get-overwatch-player-icons.getOverwatchPlayerIcons
    events:
      - httpApi:
          method: GET
          path: /v2/api/overwatch/player-icons/latest

  GetOverwatchProfile:
    handler: src/functions/get-overwatch-profile.getOverwatchProfile
    events:
      - httpApi:
          method: GET
          path: /v2/api/overwatch/profiles/{username}/latest

  ListOverwatchAccountHistory:
    handler: src/functions/list-overwatch-account-history.listOverwatchAccountHistory
    events:
      - httpApi:
          method: GET
          path: /v2/api/overwatch/accounts/{username}/history

  ListOverwatchHeroesHistory:
    handler: src/functions/list-overwatch-heroes-history.listOverwatchHeroesHistory
    events:
      - httpApi:
          method: GET
          path: /v2/api/overwatch/heroes/history

  ListOverwatchPlayerIconsHistory:
    handler: src/functions/list-overwatch-player-icons-history.listOverwatchPlayerIconsHistory
    events:
      - httpApi:
          method: GET
          path: /v2/api/overwatch/player-icons/history

  ListOverwatchProfileHistory:
    handler: src/functions/list-overwatch-profile-history.listOverwatchProfileHistory
    events:
      - httpApi:
          method: GET
          path: /v2/api/overwatch/profiles/{username}/history

  CDN:
    handler: src/functions/cdn.cdn
    events:
      - httpApi:
          method: GET
          path: /{key+}

resources:
  Resources:
    Bucket:
      Type: AWS::S3::Bucket
      Properties:
        CorsConfiguration:
          CorsRules:
            - AllowedMethods:
                - GET
              AllowedOrigins:
                - '*'

    CloudFrontBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref Bucket
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Action:
                - s3:GetObject
              Effect: Allow
              Resource:
                - !Join
                  - /
                  - - !GetAtt
                      - Bucket
                      - Arn
                    - metadata.json
                - !Join
                  - /
                  - - !GetAtt
                      - Bucket
                      - Arn
                    - v2
                    - cdn
                    - '*'
              Principal:
                CanonicalUser: !GetAtt
                  - CloudFrontOriginAccessIdentity
                  - S3CanonicalUserId
      DependsOn:
        - CloudFrontOriginAccessIdentity

    CloudFrontOriginAccessIdentity:
      Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
      Properties:
        CloudFrontOriginAccessIdentityConfig:
          Comment: ''

    CloudFrontCachePolicyOverwatchAccountOptions:
      Type: AWS::CloudFront::CachePolicy
      Properties:
        CachePolicyConfig:
          Name: ${self:custom.name}-CachingOptimizedForUncompressedObjects-OverwatchAccountOptions
          DefaultTTL: 86400
          MaxTTL: 31536000
          MinTTL: 1
          ParametersInCacheKeyAndForwardedToOrigin:
            CookiesConfig:
              CookieBehavior: none
            EnableAcceptEncodingBrotli: false
            EnableAcceptEncodingGzip: false
            HeadersConfig:
              HeaderBehavior: none
            QueryStringsConfig:
              QueryStringBehavior: whitelist
              QueryStrings:
                - platform
                - resolution_strategy

    CloudFrontCachePolicyInfraSightPaginationOptions:
      Type: AWS::CloudFront::CachePolicy
      Properties:
        CachePolicyConfig:
          Name: ${self:custom.name}-CachingOptimizedForUncompressedObjects-InfraSightPaginationOptions
          DefaultTTL: 86400
          MaxTTL: 31536000
          MinTTL: 1
          ParametersInCacheKeyAndForwardedToOrigin:
            CookiesConfig:
              CookieBehavior: none
            EnableAcceptEncodingBrotli: false
            EnableAcceptEncodingGzip: false
            HeadersConfig:
              HeaderBehavior: none
            QueryStringsConfig:
              QueryStringBehavior: whitelist
              QueryStrings:
                - token

    CloudFrontDistribution:
      Type: AWS::CloudFront::Distribution
      Properties:
        DistributionConfig:
          Aliases:
            - ${self:custom.domain}
          CacheBehaviors:
            - PathPattern: /v2/api/overwatch/accounts/*/search
              CachePolicyId: b2884449-e4de-46a7-ac36-70bc7f1ddd6d
              OriginRequestPolicyId: 59781a5b-3903-41f3-afcb-af62929ccde1
              TargetOriginId: !Join
                - ''
                - - API-
                  - !Ref HttpApi
              ViewerProtocolPolicy: redirect-to-https
            - PathPattern: /v2/api/overwatch/accounts/*/latest
              CachePolicyId: !GetAtt
                - CloudFrontCachePolicyOverwatchAccountOptions
                - Id
              OriginRequestPolicyId: 59781a5b-3903-41f3-afcb-af62929ccde1
              TargetOriginId: !Join
                - ''
                - - API-
                  - !Ref HttpApi
              ViewerProtocolPolicy: redirect-to-https
            - PathPattern: /v2/api/overwatch/heroes/latest
              CachePolicyId: b2884449-e4de-46a7-ac36-70bc7f1ddd6d
              OriginRequestPolicyId: 59781a5b-3903-41f3-afcb-af62929ccde1
              TargetOriginId: !Join
                - ''
                - - API-
                  - !Ref HttpApi
              ViewerProtocolPolicy: redirect-to-https
            - PathPattern: /v2/api/overwatch/player-icons/latest
              CachePolicyId: b2884449-e4de-46a7-ac36-70bc7f1ddd6d
              OriginRequestPolicyId: 59781a5b-3903-41f3-afcb-af62929ccde1
              TargetOriginId: !Join
                - ''
                - - API-
                  - !Ref HttpApi
              ViewerProtocolPolicy: redirect-to-https
            - PathPattern: /v2/api/overwatch/profiles/*/latest
              CachePolicyId: !GetAtt
                - CloudFrontCachePolicyOverwatchAccountOptions
                - Id
              OriginRequestPolicyId: 59781a5b-3903-41f3-afcb-af62929ccde1
              TargetOriginId: !Join
                - ''
                - - API-
                  - !Ref HttpApi
              ViewerProtocolPolicy: redirect-to-https
            - PathPattern: /v2/api/overwatch/accounts/*/history
              CachePolicyId: !GetAtt
                - CloudFrontCachePolicyInfraSightPaginationOptions
                - Id
              OriginRequestPolicyId: 59781a5b-3903-41f3-afcb-af62929ccde1
              TargetOriginId: !Join
                - ''
                - - API-
                  - !Ref HttpApi
              ViewerProtocolPolicy: redirect-to-https
            - PathPattern: /v2/api/overwatch/heroes/history
              CachePolicyId: !GetAtt
                - CloudFrontCachePolicyInfraSightPaginationOptions
                - Id
              OriginRequestPolicyId: 59781a5b-3903-41f3-afcb-af62929ccde1
              TargetOriginId: !Join
                - ''
                - - API-
                  - !Ref HttpApi
              ViewerProtocolPolicy: redirect-to-https
            - PathPattern: /v2/api/overwatch/player-icons/history
              CachePolicyId: !GetAtt
                - CloudFrontCachePolicyInfraSightPaginationOptions
                - Id
              OriginRequestPolicyId: 59781a5b-3903-41f3-afcb-af62929ccde1
              TargetOriginId: !Join
                - ''
                - - API-
                  - !Ref HttpApi
              ViewerProtocolPolicy: redirect-to-https
            - PathPattern: /v2/api/overwatch/profiles/*/history
              CachePolicyId: !GetAtt
                - CloudFrontCachePolicyInfraSightPaginationOptions
                - Id
              OriginRequestPolicyId: 59781a5b-3903-41f3-afcb-af62929ccde1
              TargetOriginId: !Join
                - ''
                - - API-
                  - !Ref HttpApi
              ViewerProtocolPolicy: redirect-to-https
          DefaultCacheBehavior:
            CachePolicyId: b2884449-e4de-46a7-ac36-70bc7f1ddd6d
            OriginRequestPolicyId: 88a5eaf4-2fd4-4709-b370-b4c650ea3fcf
            TargetOriginId: !Join
              - ''
              - - S3-
                - !Ref Bucket
                - .s3.
                - !Ref AWS::Region
                - .amazonaws.com
            ViewerProtocolPolicy: redirect-to-https
          DefaultRootObject: metadata.json
          Enabled: true
          HttpVersion: http2
          IPV6Enabled: true
          Origins:
            - S3OriginConfig:
                OriginAccessIdentity: !Join
                  - /
                  - - origin-access-identity/cloudfront
                    - !Ref CloudFrontOriginAccessIdentity
              DomainName: !Join
                - ''
                - - !Ref Bucket
                  - .s3.
                  - !Ref AWS::Region
                  - .amazonaws.com
              Id: !Join
                - ''
                - - S3-
                  - !Ref Bucket
                  - .s3.
                  - !Ref AWS::Region
                  - .amazonaws.com
            - CustomOriginConfig:
                OriginProtocolPolicy: https-only
              DomainName: !Select
                - 1
                - !Split
                  - ://
                  - !GetAtt
                    - HttpApi
                    - ApiEndpoint
              Id: !Join
                - ''
                - - API-
                  - !Ref HttpApi
          ViewerCertificate:
            AcmCertificateArn: !Ref CloudFrontCertificate
            MinimumProtocolVersion: TLSv1.2_2019
            SslSupportMethod: sni-only
      DependsOn:
        - CloudFrontOriginAccessIdentity

    CloudFrontCertificate:
      Type: AWS::CertificateManager::Certificate
      Properties:
        DomainName: ${self:custom.domain}
        ValidationMethod: DNS
